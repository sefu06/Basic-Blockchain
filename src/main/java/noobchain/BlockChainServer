package noobchain;
import static spark.Spark.*;
import com.google.gson.Gson;

public class BlockchainServer {

    public static void main(String[] args) {
        port(4567); // your server will run at localhost:4567
        Gson gson = new Gson();

        // Return the whole blockchain
        get("/blockchain", (req, res) -> {
            res.type("application/json");
            return NoobChain.blockchain;
        }, gson::toJson);

        // Get wallet balances
        get("/balance/:wallet", (req, res) -> {
            res.type("application/json");
            String walletKey = req.params("wallet");
            // just for demo; you may need to match the publicKey string
            float balance = 0f;
            if (walletKey.equals("A")) balance = NoobChain.walletA.getBalance();
            else if (walletKey.equals("B")) balance = NoobChain.walletB.getBalance();
            return "{ \"balance\": " + balance + " }";
        });

        // Send funds
        post("/transaction", (req, res) -> {
            res.type("application/json");
            TransactionRequest txRequest = gson.fromJson(req.body(), TransactionRequest.class);

            Wallet sender = txRequest.sender.equals("A") ? NoobChain.walletA : NoobChain.walletB;
            Wallet recipient = txRequest.recipient.equals("A") ? NoobChain.walletA : NoobChain.walletB;

            Block lastBlock = NoobChain.blockchain.get(NoobChain.blockchain.size() - 1);
            Block newBlock = new Block(lastBlock.hash);
            newBlock.addTransaction(sender.sendFunds(recipient.publicKey, txRequest.amount));
            NoobChain.addBlock(newBlock);

            return gson.toJson(newBlock);
        });
    }

    static class TransactionRequest {
        String sender;
        String recipient;
        float amount;
    }
}